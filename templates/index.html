<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">

<!-- ‚úÖ MOBILE VIEWPORT (CRITICAL) -->
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

<title>Student Assistant</title>
<link rel="icon" href="/static/favicon.png">

<style>
*{box-sizing:border-box;margin:0;padding:0}
body{
  height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
  background:#ece5dd;
  font-family:"Segoe UI",sans-serif;
  position:relative;
}

/* APP */
.app{
  width:380px;
  height:95vh;
  background:#efeae2;
  border-radius:16px;
  display:flex;
  flex-direction:column;
  overflow:hidden;
  box-shadow:0 10px 40px rgba(0,0,0,.25);
}

/* HEADER */
.header{
  background:#075e54;
  color:#fff;
  padding:14px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-weight:600;
}

/* LOGOUT */
.logout{
  background:#128c7e;
  border:none;
  color:#fff;
  padding:6px 16px;
  border-radius:20px;
  cursor:pointer;
  transition:.3s;
}
.logout:hover{
  background:#e53935;
  box-shadow:0 0 12px rgba(229,57,53,.9);
}

/* CHAT */
.chat{
  flex:1;
  padding:14px;
  overflow-y:auto;
  position:relative;
}

/* DATE SEPARATOR */
.date-separator{
  text-align:center;
  font-size:12px;
  color:#666;
  margin:12px 0;
  background:#efeae2;
  position:sticky;
  top:0;
  z-index:4;
}

/* ROW */
.row{display:flex;margin-bottom:10px;position:relative}
.user{justify-content:flex-end}
.bot{justify-content:flex-start}

/* AVATAR */
.avatar{
  width:28px;
  height:28px;
  border-radius:50%;
  margin-right:6px;
}

/* MESSAGE */
.msg{
  max-width:72%;
  padding:10px 12px 18px;
  border-radius:8px;
  font-size:14px;
  position:relative;
  word-wrap:break-word;
}
.user .msg{background:#dcf8c6;border-top-right-radius:0}
.bot .msg{background:#fff;border-top-left-radius:0}

/* TIME */
.time{
  position:absolute;
  bottom:4px;
  right:8px;
  font-size:11px;
  color:#777;
}

/* INPUT */
.input-area{
  display:flex;
  gap:8px;
  padding:10px;
  background:#f0f2f5;
}
input{
  flex:1;
  padding:12px;
  border-radius:24px;
  border:none;
  outline:none;
}
.btn{
  width:46px;
  height:46px;
  border-radius:50%;
  border:none;
  font-size:18px;
  color:#fff;
  cursor:pointer;
}
.send{background:#075e54}
.mic{background:#25d366}

/* MIC PULSE */
.mic.listening{
  animation:pulse 1.2s infinite;
}
@keyframes pulse{
  0%{box-shadow:0 0 0 0 rgba(37,211,102,.7)}
  70%{box-shadow:0 0 0 18px rgba(37,211,102,0)}
}

/* TYPING DOTS */
.typing{
  display:flex;
  gap:6px;
}
.typing span{
  width:7px;
  height:7px;
  background:#888;
  border-radius:50%;
  animation:blink 1.4s infinite both;
}
.typing span:nth-child(2){animation-delay:.2s}
.typing span:nth-child(3){animation-delay:.4s}

/* LISTENING TEXT */
.listen{
  display:flex;
  align-items:center;
  gap:6px;
  font-size:13px;
}
.listen span{
  width:8px;
  height:8px;
  background:#25d366;
  border-radius:50%;
  animation:blink 1s infinite;
}
@keyframes blink{
  0%{opacity:.2}
  20%{opacity:1}
  100%{opacity:.2}
}

/* WELCOME POPUP */
#welcome-popup{
  position:fixed;
  top:20px;
  right:20px;
  background:#d4f8d4;
  color:#075e54;
  padding:12px 18px;
  border-radius:12px;
  box-shadow:0 4px 12px rgba(0,0,0,.2);
  font-weight:500;
  z-index:9999;
  opacity:0;
  pointer-events:none;
  transition:all 0.5s ease;
}
#welcome-popup.show{
  opacity:1;
  pointer-events:auto;
}
/* ===== WHATSAPP-STYLE EMOJI HOVER ===== */
.reactions{
  display:flex;
  gap:6px;
  position:absolute;
  bottom:100%;
  left:0;
  background:#fff;
  padding:6px 8px;
  border-radius:18px;
  box-shadow:0 4px 12px rgba(0,0,0,.15);

  opacity:0;
  transform:translateY(10px) scale(.95);
  pointer-events:none;
  transition:opacity .18s ease, transform .18s ease;
  z-index:10;
}

/* Show on hover */
.bot .msg:hover .reactions{
  opacity:1;
  transform:translateY(0) scale(1);
  pointer-events:auto;
}

/* Emoji buttons */
.reaction{
  font-size:18px;
  cursor:pointer;
  transition:transform .15s ease;
}

/* Emoji hover bounce */
.reaction:hover{
  transform:scale(1.3);
}

/* REACTION COUNTS (WHATSAPP STYLE) */
.reaction-counts{
  position:absolute;
  bottom:-14px;
  left:16px;
  display:flex;
}

.reaction-pill{
  background:#f0f0f0;
  padding:2px 8px;
  border-radius:12px;
  font-size:13px;
  box-shadow:0 1px 3px rgba(0,0,0,.2);
}

/* ===== REACTION POP ANIMATION ===== */
@keyframes reactionPop {
  0%   { transform: scale(1); }
  40%  { transform: scale(1.5); }
  70%  { transform: scale(0.95); }
  100% { transform: scale(1); }
}

.reaction-pop {
  animation: reactionPop 0.35s ease;
}


/* ================= MOBILE FULL SCREEN ================= */
@media (max-width:600px){
  body{
    justify-content:flex-start;
    align-items:flex-start;
  }

  .app{
    width:100vw;
    height:100vh;
    border-radius:0;
  }

  .msg{
    max-width:85%;
    font-size:15px;
  }

  .btn{
    width:52px;
    height:52px;
  }
}
</style>
</head>

<body>
<div class="app">
  <div class="header">
    <span>Student Assistant</span>
    <button class="logout" onclick="location.href='/logout'">Logout</button>
  </div>

  <div class="chat" id="chat"></div>

  <div class="input-area">
    <input id="input" placeholder="Type a message‚Ä¶">
    <button class="btn send" id="send">‚û§</button>
    <button class="btn mic" id="mic">üé§</button>
  </div>
</div>

<!-- WELCOME POPUP -->
<div id="welcome-popup">üëã Students, nice to meet you! Stay positive! üåü</div>

<script>
const chat = document.getElementById("chat");
const input = document.getElementById("input");
const send = document.getElementById("send");
const mic = document.getElementById("mic");
const welcomePopup = document.getElementById("welcome-popup");

/* DATE HELPERS */
/* DATE HELPERS */
function getDateLabel(dateStr){
  const msgDate = new Date(dateStr);
  const today = new Date();
  const yesterday = new Date();
  yesterday.setDate(today.getDate() - 1);

  const sameDay = (a,b)=>a.toDateString()===b.toDateString();

  if(sameDay(msgDate, today)) return "Today";
  if(sameDay(msgDate, yesterday)) return "Yesterday";

  return msgDate.toLocaleDateString("en-IN",{
    day:"2-digit",month:"short",year:"numeric"
  });
}

function addDateSeparator(label){
  const div=document.createElement("div");
  div.className="date-separator";
  div.innerText=label;
  chat.appendChild(div);
}

// ======================
// USER MESSAGE
// ======================
function addUser(text, time){
  const row = document.createElement("div");
  row.className = "row user";
  row.innerHTML = `
    <div class="msg">
      <span class="user-text">${text}</span>
      <span class="time">${time}</span>
    </div>
  `;
  chat.appendChild(row);
  chat.scrollTop = chat.scrollHeight;
}

// ======================
// BOT MESSAGE
// ======================
function addBot(text, time){
  const row = document.createElement("div");
  row.className = "row bot";

  row.innerHTML = `
    <img src="/static/bot.png" class="avatar">
    <div class="msg">
      ${text}
      <span class="time">${time}</span>

      <div class="reactions">
        <div class="reaction" data-emoji="üëç">üëç</div>
        <div class="reaction" data-emoji="‚ù§Ô∏è">‚ù§Ô∏è</div>
        <div class="reaction" data-emoji="üòÇ">üòÇ</div>
        <div class="reaction" data-emoji="üòÆ">üòÆ</div>
        <div class="reaction" data-emoji="üò¢">üò¢</div>
        <div class="reaction" data-emoji="üëè">üëè</div>
      </div>
      <div class="reaction-counts"></div>
    </div>
  `;

  chat.appendChild(row);
  chat.scrollTop = chat.scrollHeight;
  enableEmojiReactions(row);

  // Load reaction counts for this message immediately
  const messageText = row.querySelector(".msg").innerText.trim();
  loadReactions(messageText);
}

// ======================
// TYPING DOTS
// ======================
function typingDots(){
  const row = document.createElement("div");
  row.className = "row bot";
  row.id = "typing";
  row.innerHTML = `
    <img src="/static/bot.png" class="avatar">
    <div class="msg">
      <div class="typing">
        <span></span><span></span><span></span>
      </div>
    </div>
  `;
  chat.appendChild(row);
  chat.scrollTop = chat.scrollHeight;
}

// ======================
// SEND MESSAGE
// ======================
async function sendMsg(){
  const text = input.value.trim();
  if(!text) return;

  const time = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
  addUser(text, time);
  input.value = "";
  typingDots();

  const r = await fetch("/chat",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({message:text})
  });
  const d = await r.json();

  setTimeout(()=>{
    document.getElementById("typing")?.remove();
    const botTime = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    addBot(d.response, botTime);
  }, 700);
}

send.onclick = sendMsg;
input.addEventListener("keydown", e=>{
  if(e.key === "Enter") sendMsg();
});

// ======================
// MIC LISTENING
// ======================
mic.onclick = ()=>{
  const rec = new webkitSpeechRecognition();
  mic.classList.add("listening");
  listeningBubble();

  rec.onresult = e=>{
    input.value = e.results[0][0].transcript;
    sendMsg();
  };

  rec.onend = ()=>{
    mic.classList.remove("listening");
    document.getElementById("listening")?.remove();
  };

  rec.start();
};

function listeningBubble(){
  const row = document.createElement("div");
  row.className = "row bot";
  row.id = "listening";
  row.innerHTML = `
    <img src="/static/bot.png" class="avatar">
    <div class="msg">
      <div class="listen">
        <span></span>Listening‚Ä¶
      </div>
    </div>
  `;
  chat.appendChild(row);
  chat.scrollTop = chat.scrollHeight;
}

// ======================
// EMOJI REACTIONS
// WhatsApp PERSONAL CHAT behavior
// ======================
function enableEmojiReactions(botRow){
  const picker = botRow.querySelector(".reactions");
  const msg = botRow.querySelector(".msg");

  let countBox = msg.querySelector(".reaction-counts");
  if(!countBox){
    countBox = document.createElement("div");
    countBox.className = "reaction-counts";
    msg.appendChild(countBox);
  }

  picker.querySelectorAll(".reaction").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const emoji = btn.dataset.emoji;
      const messageText = msg.innerText.trim();

      // Save reaction to DB
      fetch("/save_reaction",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({message: messageText, emoji: emoji})
      }).then(res=>{
        loadReactions(messageText);
      });

      // WhatsApp personal chat: one reaction only
      countBox.innerHTML = `
        <div class="reaction-pill reaction-pop">${emoji} 1</div>
      `;

      const pill = countBox.querySelector(".reaction-pill");
      pill.classList.remove("reaction-pop");
      void pill.offsetWidth;
      pill.classList.add("reaction-pop");
    });
  });
}

// ======================
// LOAD REACTIONS FROM DB
// ======================
function loadReactions(messageText){
  fetch(`/load_reaction?message=${encodeURIComponent(messageText)}`)
    .then(r=>r.json())
    .then(data=>{
      const msgDivs = document.querySelectorAll(`.bot .msg`);
      msgDivs.forEach(div=>{
        if(div.innerText.includes(messageText)){
          const countBox = div.querySelector(".reaction-counts");
          if(countBox){
            countBox.innerHTML = "";
            data.forEach(r=>{
              const pill = document.createElement("div");
              pill.className = "reaction-pill";
              pill.innerText = `${r.emoji} ${r.count}`;
              countBox.appendChild(pill);
            });
          }
        }
      });
    })
    .catch(err=>console.log("Error loading reactions:", err));
}

// ====== LOAD HISTORY ======
window.addEventListener("load", async ()=>{

  // Welcome popup
  welcomePopup.classList.add("show");
  setTimeout(()=>welcomePopup.classList.remove("show"),3000);

  try{
    const r = await fetch("/load_history");
    const data = await r.json();
    const history = Array.isArray(data.history) ? data.history : [];

    if(history.length === 0){
      addBot("üëã Hi student, nice to see you! How can I help you today?",
        new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}));
      return;
    }

    let lastLabel = "";

    history.forEach((m)=>{
      // üëá Get date label based on DB date
      const msgDate = m.date ? m.date : new Date().toISOString().split("T")[0];
      const label = getDateLabel(msgDate);

      if(label !== lastLabel){
        addDateSeparator(label);
        lastLabel = label;
      }

      if(m.sender === "user") addUser(m.message, m.time);
      else addBot(m.message, m.time);
    });

  }catch(err){
    console.error("History load error:", err);
  }
});

</script>
</body>
</html>
